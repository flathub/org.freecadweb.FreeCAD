app-id: org.freecadweb.FreeCAD
branch: stable
base: io.qt.qtwebkit.BaseApp
base-version: '5.12'
runtime: org.kde.Platform
runtime-version: '5.12'
sdk: org.kde.Sdk
command: FreeCAD
finish-args:
  - --socket=wayland
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --filesystem=host # needed to make file saving work
  - --env=PYTHONPATH=/app/lib/python2.7/site-packages
cleanup:
  - /include
  - /share/aclocal
  - /share/doc
  - /share/cmake
  - /share/man
  - '*.a'
  - '*.la'
cleanup-commands: # https://github.com/flatpak/flatpak-builder/issues/233
  - rm -rf /app/{include,lib/{cmake,mkspecs,pkgconfig}}
modules:
  - shared-modules/glu/glu-9.0.0.json
  - shared-modules/python2.7/python-2.7.15.json

  - name: pyside2
    buildsystem: simple
    build-commands:
      - mkdir -p /app/qt5include && cp -R /usr/include/Qt* /app/qt5include # https://bugreports.qt.io/browse/PYSIDE-787
      - cd sources/shiboken2 && mkdir _build && cd _build &&
        cmake -GNinja
        -DCMAKE_BUILD_TYPE=RelWithDebInfo
        -DCMAKE_INSTALL_PREFIX=/app
        -DUSE_PYTHON_VERSION=2
        -DBUILD_TESTS=OFF .. &&
        ninja install
      - cd sources/pyside2 && mkdir _build && cd _build &&
        cmake -GNinja
        -DCMAKE_BUILD_TYPE=RelWithDebInfo
        -DCMAKE_INSTALL_PREFIX=/app
        -DUSE_PYTHON_VERSION=2
        -DBUILD_TESTS=OFF .. &&
        ninja install
      - cd sources/pyside2-tools && mkdir _build && cd _build &&
        cmake -GNinja
        -DCMAKE_BUILD_TYPE=RelWithDebInfo
        -DCMAKE_INSTALL_PREFIX=/app
        -DBUILD_TESTS=OFF .. &&
        ninja install
    cleanup:
      - /qt5include
      - /bin
    sources:
      - type: archive
        url: https://download.qt.io/official_releases/QtForPython/pyside2/PySide2-5.12.1-src/pyside-setup-everywhere-src-5.12.1.tar.xz
        sha256: 6e26b6240b97558b8bf3c97810e950ef4121a03a1ebdecfb649992a505f18059
      - type: shell
        commands:
          - sed -i 's|\(--include-paths=\)|\1/app/qt5include:|' sources/pyside2/cmake/Macros/PySideModules.cmake

  - name: swig
    config-opts:
      - --without-pcre
    cleanup:
      - '*'
    sources:
      - type: archive
        url: http://http.debian.net/debian/pool/main/s/swig/swig_3.0.12.orig.tar.gz
        sha256: 7cf9f447ae7ed1c51722efc45e7f14418d15d7a1e143ac9f09a668999f4fc94d

  - name: libXmu
    sources:
      - type: archive
        url: https://www.x.org/archive//individual/lib/libXmu-1.1.2.tar.bz2
        sha256: 756edc7c383254eef8b4e1b733c3bf1dc061b523c9f9833ac7058378b8349d0b

  - name: eigen
    buildsystem: cmake-ninja
    builddir: true
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://bitbucket.org/eigen/eigen/get/3.3.5.tar.bz2
        sha256: 7352bff3ea299e4c7d7fbe31c504f8eb9149d7e685dec5a12fbaa26379f603e2

  - name: tcl
    subdir: unix
    build-options:
      no-debuginfo: true
    cleanup:
      - /bin
      - /man
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/tcl/Tcl/8.6.8/tcl8.6.8-src.tar.gz
        sha256: c43cb0c1518ce42b00e7c8f6eaddd5195c53a98f94adc717234a65cbcfd3f96a

  - name: tk
    subdir: unix
    build-options:
      no-debuginfo: true
    make-install-args:
      - install-private-headers
    cleanup:
      - /bin
      - /man
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/tcl/Tcl/8.6.8/tk8.6.8-src.tar.gz
        sha256: 49e7bca08dde95195a27f594f7c850b088be357a7c7096e44e1158c7a5fd7b33

  - name: graphviz
    rm-configure: true
    sources:
      - type: archive
        url: https://ftp.osuosl.org/pub/blfs/conglomeration/graphviz/graphviz-2.40.1.tar.gz
        sha256: ca5218fade0204d59947126c38439f432853543b0818d9d728c589dfe7f3a421
      - type: shell
        commands:
          - sed -i '/LIBPOSTFIX="64"/s/64//' configure.ac

  - name: xerces-c
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://archive.apache.org/dist/xerces/c/3/sources/xerces-c-3.2.2.tar.xz
        sha256: 6daca3b23364d8d883dc77a73f681242f69389e3564543287ed3d073007e0a8e

  - name: openmpi
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.open-mpi.org/release/open-mpi/v3.1/openmpi-3.1.1.tar.bz2
        sha256: 3f11b648dd18a8b878d057e9777f2c43bf78297751ad77ae2cef6db0fe80c77c

  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8/hdf5-1.8.21/src/hdf5-1.8.21.tar.bz2
        sha256: e5b1b1dee44a64b795a91c3321ab7196d9e0871fe50d42969761794e3899f40d

  - name: med
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: http://files.salome-platform.org/Salome/other/med-3.3.1.tar.gz
        sha256: dd631ef813838bc7413ff0dd6461d7a0d725bcfababdf772ece67610a8d22588

  - name: libspnav
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/spacenav/spacenav%20library%20%28SDK%29/libspnav%200.2.3/libspnav-0.2.3.tar.gz
        sha256: 7ae4d7bb7f6a5dda28b487891e01accc856311440f582299760dace6ee5f1f93

  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app --with-libraries=filesystem,program_options,regex,signals,system,thread,python,date_time
      - ./b2 -j $FLATPAK_BUILDER_N_JOBS install
    sources:
      - type: archive
        url: https://dl.bintray.com/boostorg/release/1.67.0/source/boost_1_67_0.tar.bz2
        sha256: 2684c972994ee57fc5632e03bf044746f6eb45d4920c343937a465fd67a5adba

  - name: coin3d
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://bitbucket.org/Coin3D/coin/get/8e8337f61b05.tar.gz
        sha256: 8319cfa699afac0e5f19054222c25a7ad655f018f7c3c7b53f626e7b167cb08e

  - name: soqt
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DSOQT_BUILD_DOCUMENTATION=OFF
    post-install:
      - sed -i '/Qt5/d' /app/lib/cmake/SoQt-1.6.0/soqt-config.cmake
    sources:
      - type: archive
        dest: data
        url: https://bitbucket.org/Coin3D/soanydata/get/f429a8af862816d781175af84850b12ac43797a3.tar.gz
        sha256: f77ef2484e71a96d50693e354ad544cced88abd7adb389a9459f26e6c7844119
      - type: archive
        dest: src/Inventor/Qt/common
        url: https://bitbucket.org/Coin3D/sogui/get/04d1d8732971d9681d60ddd1d0c2ddbb0549c131.tar.gz
        sha256: a1994750414a16e285d4a08df64fedf98479bd826af19bb4b71f11c24118e95b
      - type: archive
        url: https://bitbucket.org/Coin3D/soqt/get/bef9d6df88b9bf3e8f6c51325da002342128aec7.tar.gz
        sha256: ed1d0447bf6b394f8765372a15cb4be7e6651a508ed3435a3d21c75170c55a4e
      - type: shell
        commands:
          - sed -i '/cpack/d' CMakeLists.txt

  - name: pivy
    buildsystem: simple
    build-commands:
      - python2 setup.py build
      - python2 setup.py install --prefix=/app
    build-options:
      env:
        PREFIX: /app
    sources:
      - type: archive
        url: https://bitbucket.org/Coin3D/pivy/get/db2e64a4a8803f4fbbcb4e03efaf37e5f988bcec.tar.gz
        sha256: 3fcf4d3351d05db15bdd4442b349e472600d1379a78bf534774d96149d392fde
      - type: shell
        commands:
          - sed -i 's|QUIET|REQUIRED|g' CMakeLists.txt
          - sed -i 's|-Iinterfaces|-Iinterfaces -I/app/include|' setup.py

  - name: numpy
    buildsystem: simple
    build-commands:
      - python2 setup.py build -j $FLATPAK_BUILDER_N_JOBS install --prefix=/app
    cleanup:
      - /bin
      - /lib/python2.7/site-packages/numpy/tests
      - /lib/python2.7/site-packages/numpy/*/tests
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/3a/20/c81632328b1a4e1db65f45c0a1350a9c5341fd4bbb8ea66cdd98da56fe2e/numpy-1.15.0.zip
        sha256: f28e73cf18d37a413f7d5de35d024e6b98f14566a10d82100f9dc491a7d449f9

  - name: matplotlib
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/eb/a0/31b6ba00bc4dcbc06f0b80d1ad6119a9cc3081ecb04a00117f6c1ca3a084/matplotlib-2.2.3.tar.gz
        sha256: 7355bf757ecacd5f0ac9dd9523c8e1a1103faadf8d33c22664178e17533f8ce5

  - name: six
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/16/d8/bc6316cf98419719bd59c91742194c111b6f2e85abac88e496adefaf7afe/six-1.11.0.tar.gz
        sha256: 70e8a77beed4562e7f14fe23a786b54f6296e34344c23bc42f07b15018ff98e9

  - name: pyparsing
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/3c/ec/a94f8cf7274ea60b5413df054f82a8980523efd712ec55a59e7c3357cf7c/pyparsing-2.2.0.tar.gz
        sha256: 0832bcf47acd283788593e7a0f542407bd9550a55a8a8435214a1960e04bcb04

  - name: setuptools_scm
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/09/b4/d148a70543b42ff3d81d57381f33104f32b91f970ad7873f463e75bf7453/setuptools_scm-3.1.0.tar.gz
        sha256: 1191f2a136b5e86f7ca8ab00a97ef7aef997131f1f6d4971be69a1ef387d8b40

  - name: backports
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/57/d4/156eb5fbb08d2e85ab0a632e2bebdad355798dece07d4752f66a8d02d1ea/backports.functools_lru_cache-1.5.tar.gz
        sha256: 9d98697f088eb1b0fa451391f91afb5e3ebde16bbdb272819fd091151fda4f1a

  - name: cycler
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/c2/4b/137dea450d6e1e3d474e1d873cd1d4f7d3beed7e0dc973b06e8e10d32488/cycler-0.10.0.tar.gz
        sha256: cd7b2d1018258d7247a71425e9f26463dfb444d411c39569972f4ce586b0c9d8

  - name: python-dateutil
    buildsystem: simple
    build-commands:
      - python2 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/a0/b0/a4e3241d2dee665fea11baec21389aec6886655cd4db7647ddf96c3fad15/python-dateutil-2.7.3.tar.gz
        sha256: e27001de32f627c22380a688bcc43ce83504a7bc5da472209b4c70f02829f0b8

  - name: geos
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://download.osgeo.org/geos/geos-3.7.0.tar.bz2
        sha256: 4fbf41a792fd74293ab59e0a980e8654cd411a9d45416d66eaa12d53d1393fd7

  - name: netcdf
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://www.unidata.ucar.edu/downloads/netcdf/ftp/netcdf-4.6.1.tar.gz
        sha256: 89c7957458740b763ae828c345240b8a1d29c2c1fed0f065f99b73181b0b2642

  - name: freeimage
    buildsystem: simple
    build-commands:
      - sh gensrclist.sh
      - sh genfipsrclist.sh
      - make -f Makefile.gnu -j $FLATPAK_BUILDER_N_JOBS
      - make -f Makefile.fip -j $FLATPAK_BUILDER_N_JOBS
      - make -f Makefile.gnu INCDIR=/app/include INSTALLDIR=/app/lib install
      - make -f Makefile.fip INCDIR=/app/include INSTALLDIR=/app/lib install
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/freeimage/Source%20Distribution/3.18.0/FreeImage3180.zip
        sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
      - type: shell
        commands:
          - sed -i 's/-o root -g root //g' Makefile.{gnu,fip}

  - name: tbb
    buildsystem: simple
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS
      - install -d /app/lib
      - install -m755 build/linux_*/*.so* /app/lib
      - install -d /app/include
      - cp -a include/tbb /app/include
    sources:
      - type: archive
        url: https://github.com/01org/tbb/archive/2019_U1.tar.gz
        sha256: a4875c6b6853213083e52ecd303546bdf424568ec67cfc7e51d132a7c037c66a

  - name: VTK
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://www.vtk.org/files/release/8.1/VTK-8.1.1.tar.gz
        sha256: 71a09b4340f0a9c58559fe946dc745ab68a866cf20636a41d97b6046cb736324

  - name: opencascade
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DUSE_FREEIMAGE=ON
      - -DUSE_VTK=ON
      - -DUSE_TBB=ON
    cleanup:
      - /bin
    sources:
      - type: archive
        url: http://http.debian.net/debian/pool/main/o/opencascade/opencascade_7.3.0+dfsg1.orig.tar.gz
        sha256: f829ee485c0edaf68c845999c38e16604cf333a7bfd44d0d598ef16ed430ac3f
      - type: patch
        path: patches/opencascade-vtk.patch

  - name: IfcOpenShell
    buildsystem: cmake-ninja
    builddir: true
    subdir: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DOCC_INCLUDE_DIR=/app/include/opencascade
      - -DOCC_LIBRARY_DIR=/app/lib
      - -DCOLLADA_SUPPORT=OFF
      - -DPYTHON_INCLUDE_DIR=/app/include/python2.7
      - -DPYTHON_LIBRARY=/app/lib/libpython2.7.so
    build-commands:
      - sed -i 's|/usr|/app|g' ifcwrap/cmake_install.cmake
    sources:
      - type: git
        url: https://github.com/IfcOpenShell/IfcOpenShell.git
        commit: e4fdfd2eb38048523ba5be99430fe7772f2dc2ed

  - name: lapack
    buildsystem: cmake
    builddir: true
    sources:
      - type: archive
        url: http://www.netlib.org/lapack/lapack-3.8.0.tar.gz
        sha256: deb22cc4a6120bff72621155a9917f485f96ef8319ac074a7afbc68aab88bcf6
        mirror-urls:
          - http://deb.debian.org/debian/pool/main/l/lapack/lapack_3.8.0.orig.tar.gz

  - name: arpack
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/opencollab/arpack-ng/archive/3.6.3.tar.gz
        sha256: 64f3551e5a2f8497399d82af3076b6a33bf1bc95fc46bbcabe66442db366f453

  - name: spooles
    buildsystem: simple
    build-commands:
      - make lib
      - make -C MT/src
      - install -Dt /app/lib *.a MT/src/*.a
      - for f in $(find -name '*.h'); do install -Dt "/app/include/$(dirname "$f")" "$f"; done
    sources:
      - type: archive
        url: http://www.netlib.org/linalg/spooles/spooles.2.2.tgz
        sha256: a84559a0e987a1e423055ef4fdf3035d55b65bbe4bf915efaa1a35bef7f8c5dd
        strip-components: 0
        mirror-urls:
          - http://deb.debian.org/debian/pool/main/s/spooles/spooles_2.2.orig.tar.gz
      - type: patch
        path: patches/spooles-gcc.patch

  - name: openblas
    buildsystem: simple
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.2.20.tar.gz
        sha256: 5ef38b15d9c652985774869efd548b8e3e972e1e99475c673b25537ed7bcf394

  - name: gfortran-mods # https://gitlab.com/freedesktop-sdk/freedesktop-sdk/issues/684
    buildsystem: simple
    build-options:
      no-debuginfo: true
    build-commands:
      - mkdir -p /app/gfortran-mods
      - cp -vR lib/gcc/x86_64-pc-linux-gnu/*.*.*/finclude/* /app/gfortran-mods
    cleanup:
      - '*'
    sources:
      - type: archive
        url: http://gfortran.meteodat.ch/download/x86_64/releases/gcc-8.3.0.tar.xz
        sha256: 35fd6205252b32552dbb332d5903146c57217930951915758d5290543145aa03

  - name: calculix-ccx
    buildsystem: simple
    build-commands:
      - make -C ccx_*/src -f Makefile_MT -j $FLATPAK_BUILDER_N_JOBS
      - install -m0755 ccx_*/src/ccx_*_MT /app/bin/ccx
    sources:
      - type: archive
        url: http://www.dhondt.de/ccx_2.15.src.tar.bz2
        sha256: bc7dba721935af51b60c1b5aa1529a420476fc6432a7bec5254f8dfabaeb8a34
      - type: patch
        path: patches/calculix-cxx-paths.patch
      - type: shell
        commands:
          - sed -i 's|FFLAGS = |FFLAGS = -I/app/gfortran-mods |g' ccx_2.15/src/Makefile_MT

  - name: gmsh
    buildsystem: cmake-ninja
    cleanup:
      - /share/doc
    sources:
      - type: archive
        url: http://gmsh.info/src/gmsh-4.0.7-source.tgz
        sha256: c6572320d0ffdf7d2488e113861bc4bd9c38a29f7fc5b67957f6fbcb63fbdbd5

  - name: FreeCAD
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      env:
        PYTHONPATH: /app/lib/python2.7/site-packages
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_PREFIX=/app/freecad
      - -DCMAKE_PREFIX_PATH=/app
      - -DBUILD_QT5=ON
    post-install:
      - mv /app/freecad/share/* /app/share
      - ln -s /app/freecad/bin/FreeCADCmd /app/bin/FreeCADCmd
      - install -D ../FreeCAD.sh /app/bin/FreeCAD
    cleanup:
      - /freecad/doc
    sources:
      - type: script
        dest-filename: FreeCAD.sh
        commands:
          - exec /app/freecad/bin/FreeCAD -u ${XDG_CONFIG_HOME}/FreeCAD/user.conf -s ${XDG_CONFIG_HOME}/FreeCAD/system.cfg "$@"
      - type: git
        url: https://github.com/FreeCAD/FreeCAD.git
        commit: 3129ae4296e40ed20e7b3d460b86e6969acbe1c3
        tag: '0.18.3'
      - type: shell
        commands:
          - sed -i 's|@PACKAGE_VERSION@|0.18.3|' src/XDGData/org.freecadweb.FreeCAD.appdata.xml.in
          - sed -i 's|/usr|/app|g' cMake/FindOpenCasCade.cmake src/Gui/GraphvizView.cpp
